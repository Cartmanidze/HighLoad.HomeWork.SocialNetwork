

# Инструкция по запуску приложения и выполнению нагрузочного тестирования

# Примечание

Отчёты о проделанной работе хранятся в папке reports

## Описание конфигурации

`docker-compose.yml` определяет инфраструктуру с сервисами:

- **Prometheus (9090)**: сбор метрик.
- **Grafana (3000)**: визуализация метрик и дашборды.
- **PostgreSQL мастер (5432)**: основная база данных для записей.
- **Инициализация репликационных слотов (init-slots)**: создаёт слоты репликации для слейвов после того, как мастер станет доступен.
- **PostgreSQL slave1 (5433) и slave2 (5434)**: слейвы, реплицирующие данные от мастера. Используются для чтения.
- **Приложение (8080)**: собственно ваш сервис, подключенный к мастеру и двум слейвам. Запросы на чтение направляются на слейвы, на запись — на мастер.
- **K6**: инструмент для нагрузочного тестирования.

## Запуск инфраструктуры

1. Убедитесь, что у вас установлен Docker и Docker Compose.
2. Клонируйте репозиторий или поместите `docker-compose.yml` и необходимые папки (`prometheus`, `grafana`, `initdb-master`, `postgres-data`, `k6-scripts`) в одну директорию.
3. Запустите все сервисы:
   ```bash
   docker compose up -d
   ```

Это развернёт Prometheus, Grafana, мастер и слейвы PostgreSQL, а также ваше приложение.

## Проверка статуса и доступ

- Приложение доступно на порту `8080`:
  ```
  http://localhost:8080
  ```

- Prometheus доступен на порту `9090`:
  ```
  http://localhost:9090
  ```

- Grafana доступна на порту `3000`:
  ```
  http://localhost:3000
  ```
  Гостевой доступ включён, вы сразу увидите дашборды и сможете наблюдать метрики.

## Нагрузочное тестирование

Для нагрузки используются скрипты в папке `k6-scripts`. Предположим, что там лежат два скрипта:

- `load-test.js` — для нагрузки на чтение (обращения к слейвам).
- `load-write-test.js` — для нагрузки на запись (обращения к мастеру).

Выполните нагрузку на чтение:
```bash
docker compose run k6 run /scripts/load-test.js
```

Выполните нагрузку на запись:
```bash
docker compose run k6 run /scripts/load-write-test.js
```

При запуске этих команд будут созданы временные контейнеры для `k6`, которые выполнят нагрузочный тест, используя соответствующие скрипты.

## Остановка и очистка

Для остановки всех сервисов выполните:
```bash
docker compose down
```

Это остановит и удалит контейнеры, но сохранит данные в томах (`./postgres-data`), если вы захотите сохранить состояние базы.

Если хотите полностью очистить данные, удалите или очистите соответствующие директории с данными вручную.
